<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SFTPFileSystemProvider.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">nio-fs-sftp</a> &gt; <a href="index.source.html" class="el_package">no.maddin.niofs.sftp</a> &gt; <span class="el_source">SFTPFileSystemProvider.java</span></div><h1>SFTPFileSystemProvider.java</h1><pre class="source lang-java linenums">package no.maddin.niofs.sftp;

import com.jcraft.jsch.*;

import java.io.IOException;
import java.net.URI;
import java.net.URISyntaxException;
import java.nio.channels.SeekableByteChannel;
import java.nio.file.*;
import java.nio.file.DirectoryStream.Filter;
import java.nio.file.attribute.BasicFileAttributes;
import java.nio.file.attribute.FileAttribute;
import java.nio.file.attribute.FileAttributeView;
import java.nio.file.spi.FileSystemProvider;
import java.util.*;

/**
 * FileSystemProvider for Secure FTP.
 */
public class SFTPFileSystemProvider extends FileSystemProvider {
    private static final String SFTP = &quot;sftp&quot;;
    private static final int DEFAULT_PORT = 22;
<span class="fc" id="L23">    private final Map&lt;URI, SFTPHost&gt; hosts = new HashMap&lt;&gt;();</span>

<span class="fc" id="L25">    private JSch jsch = new JSch();</span>

<span class="fc" id="L27">    public SFTPFileSystemProvider() {</span>
<span class="fc" id="L28">        JSch.setConfig(&quot;StrictHostKeyChecking&quot;, &quot;no&quot;);</span>
<span class="fc" id="L29">    }</span>

    @Override
    public String getScheme() {
<span class="fc" id="L33">        return SFTP;</span>
    }

    @Override
    public FileSystem newFileSystem(URI uri, Map&lt;String, ?&gt; env) throws IOException {
        try {
<span class="fc" id="L39">            return getSFTPHost(uri, true);</span>
<span class="nc" id="L40">        } catch(URISyntaxException e) {</span>
<span class="nc" id="L41">            throw new FileSystemException(e.toString());</span>
        }
    }

    @Override
    public FileSystem getFileSystem(URI uri) {
        try {
<span class="fc" id="L48">            return getSFTPHost(uri, true);</span>
<span class="nc" id="L49">        } catch(URISyntaxException ex) {</span>
<span class="nc" id="L50">            throw new FileSystemNotFoundException(uri.toString());</span>
        }
    }

    @Override
    public Path getPath(URI uri) {
        try {
<span class="fc" id="L57">            SFTPHost host = getSFTPHost(uri, true);</span>
<span class="fc" id="L58">            return new SFTPPath(host, uri.getPath());</span>
<span class="nc" id="L59">        } catch(URISyntaxException e) {</span>
<span class="nc" id="L60">            throw new FileSystemNotFoundException(uri.toString());</span>
        }
    }

    /**
     * Get a SFTP Host with the given host, user, password and port.
     *
     * @param uri valid URI
     * @param create
     *        if {@code true} a new SFTPHost is created if none is registered.
     */
    private SFTPHost getSFTPHost(URI uri, boolean create) throws URISyntaxException {
<span class="fc" id="L72">        String host = uri.getHost();</span>
<span class="pc bpc" id="L73" title="1 of 2 branches missed.">        if (host == null) {</span>
<span class="nc" id="L74">            throw new IllegalArgumentException(uri.toString());</span>
        }
<span class="fc" id="L76">        int port = uri.getPort();</span>
<span class="pc bpc" id="L77" title="1 of 2 branches missed.">        if (port == -1) {</span>
<span class="fc" id="L78">            port = DEFAULT_PORT;</span>
        }
<span class="fc" id="L80">        String userInfo = uri.getUserInfo();</span>
<span class="fc" id="L81">        URI serverUri = new URI(getScheme(), userInfo, host, port, null, null, null);</span>

<span class="fc" id="L83">        synchronized (hosts) {</span>
<span class="fc" id="L84">            SFTPHost fs = hosts.get(serverUri);</span>
<span class="pc bpc" id="L85" title="1 of 4 branches missed.">            if (fs == null &amp;&amp; create) {</span>
<span class="fc" id="L86">                fs = new SFTPHost(this, serverUri);</span>
<span class="fc" id="L87">                hosts.put(serverUri, fs);</span>
            }
<span class="fc" id="L89">            return fs;</span>
<span class="nc" id="L90">        }</span>
    }

    @Override
    public SeekableByteChannel newByteChannel(Path path, Set&lt;? extends OpenOption&gt; options, FileAttribute&lt;?&gt;... attrs) throws IOException {
<span class="nc" id="L95">        throw new UnsupportedOperationException();</span>
    }

    @Override
    public DirectoryStream&lt;Path&gt; newDirectoryStream(Path dir, Filter&lt;? super Path&gt; filter) throws IOException {
<span class="nc" id="L100">        throw new UnsupportedOperationException();</span>
    }

    @Override
    public void createDirectory(Path dir, FileAttribute&lt;?&gt;... attrs) throws IOException {
<span class="nc bnc" id="L105" title="All 2 branches missed.">        if (!(dir instanceof SFTPPath)) {</span>
<span class="nc" id="L106">            throw new IllegalArgumentException(dir.toString());</span>
        }

<span class="nc" id="L109">        SFTPHost sftpHost = (SFTPHost)dir.getFileSystem();</span>

<span class="nc" id="L111">        String username = sftpHost.getUserName();</span>
<span class="nc" id="L112">        String host = sftpHost.getHost();</span>
<span class="nc" id="L113">        int port = sftpHost.getPort();</span>
        Session session;
        try {
<span class="nc" id="L116">            session = jsch.getSession(username, host, port);</span>
<span class="nc" id="L117">            UserInfo userinfo = new SFTPUserInfo(sftpHost.getPassword());</span>
<span class="nc" id="L118">            session.setUserInfo(userinfo);</span>
<span class="nc" id="L119">            session.connect();</span>

<span class="nc" id="L121">            ChannelSftp sftp = (ChannelSftp)session.openChannel(SFTP);</span>

<span class="nc" id="L123">            sftp.connect();</span>

<span class="nc" id="L125">            List&lt;String&gt; parts = ((SFTPPath) dir).getParts();</span>
            // remove the first part if it is the root directory (empty string)
<span class="nc bnc" id="L127" title="All 4 branches missed.">            if (!parts.isEmpty() &amp;&amp; &quot;&quot;.equals(parts.get(0))) {</span>
<span class="nc" id="L128">                parts = parts.subList(1, parts.size()-1);</span>
            }
            // Implementation might not support recursive creation of directories
<span class="nc bnc" id="L131" title="All 2 branches missed.">            for (String subPath : parts) {</span>
                try {
<span class="nc" id="L133">                    sftp.mkdir(subPath);</span>
<span class="nc" id="L134">                } catch(SftpException e) {</span>
<span class="nc" id="L135">                    throw new IOException(subPath, e);</span>
<span class="nc" id="L136">                }</span>

<span class="nc" id="L138">            }</span>

<span class="nc" id="L140">            sftp.quit();</span>

<span class="nc" id="L142">            session.disconnect();</span>
            //throw new UnsupportedOperationException();
<span class="nc" id="L144">        } catch(JSchException e) {</span>
<span class="nc" id="L145">            throw new IOException(e);</span>
<span class="nc" id="L146">        }</span>
<span class="nc" id="L147">    }</span>

    @Override
    public void delete(Path path) throws IOException {
<span class="nc" id="L151">        throw new UnsupportedOperationException();</span>
    }

    @Override
    public void copy(Path source, Path target, CopyOption... options) throws IOException {
<span class="nc" id="L156">        throw new UnsupportedOperationException();</span>
    }

    @Override
    public void move(Path source, Path target, CopyOption... options) throws IOException {
<span class="nc" id="L161">        throw new UnsupportedOperationException();</span>
    }

    @Override
    public boolean isSameFile(Path path, Path path2) throws IOException {
<span class="nc" id="L166">        throw new UnsupportedOperationException();</span>
    }

    @Override
    public boolean isHidden(Path path) throws IOException {
<span class="nc" id="L171">        throw new UnsupportedOperationException();</span>
    }

    @Override
    public FileStore getFileStore(Path path) throws IOException {
<span class="nc" id="L176">        throw new UnsupportedOperationException();</span>
    }

    @Override
    public void checkAccess(Path path, AccessMode... modes) throws IOException {
<span class="nc" id="L181">        throw new UnsupportedOperationException();</span>
    }

    @Override
    public &lt;V extends FileAttributeView&gt; V getFileAttributeView(Path path, Class&lt;V&gt; type, LinkOption... options) {
<span class="nc" id="L186">        throw new UnsupportedOperationException();</span>
    }

    @Override
    public &lt;A extends BasicFileAttributes&gt; A readAttributes(Path path, Class&lt;A&gt; type, LinkOption... options) throws IOException {
<span class="nc" id="L191">        throw new UnsupportedOperationException();</span>
    }

    @Override
    public Map&lt;String, Object&gt; readAttributes(Path path, String attributes, LinkOption... options) throws IOException {
<span class="nc" id="L196">        throw new UnsupportedOperationException();</span>
    }

    @Override
    public void setAttribute(Path path, String attribute, Object value, LinkOption... options) throws IOException {
<span class="nc" id="L201">        throw new UnsupportedOperationException();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>