<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SMBFileSystemProvider.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">nio-fs-smb</a> &gt; <a href="index.source.html" class="el_package">no.maddin.niofs.smb</a> &gt; <span class="el_source">SMBFileSystemProvider.java</span></div><h1>SMBFileSystemProvider.java</h1><pre class="source lang-java linenums">package no.maddin.niofs.smb;

import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.PrintStream;
import java.net.URI;
import java.net.URISyntaxException;
import java.nio.channels.SeekableByteChannel;
import java.nio.file.*;
import java.nio.file.DirectoryStream.Filter;
import java.nio.file.attribute.BasicFileAttributes;
import java.nio.file.attribute.FileAttribute;
import java.nio.file.attribute.FileAttributeView;
import java.nio.file.spi.FileSystemProvider;
import java.util.Map;
import java.util.Set;
import java.util.logging.Logger;

import jcifs.Config;
import jcifs.smb.NtStatus;
import jcifs.smb.SmbException;

/**
 * Provider based on jcifs. 
 * jCifs can be configured with &lt;code&gt;/jcifs-config.properties&lt;/code&gt;, if jCifs properties are not already loaded.
 * If it was previously configured, a warning is issued. 
 */
public class SMBFileSystemProvider extends FileSystemProvider {

<span class="nc" id="L31">    private static final Logger log = Logger.getLogger(SMBFileSystemProvider.class.getName());</span>

<span class="nc" id="L33">    public SMBFileSystemProvider() throws IOException {</span>

<span class="nc bnc" id="L35" title="All 2 branches missed.">        if (hasConfig()) {</span>
<span class="nc" id="L36">            log.warning(&quot;jcifs already configured, reconfiguring it.&quot;);</span>
        }
<span class="nc" id="L38">        try (InputStream config = getClass().getResourceAsStream(&quot;/jcifs-config.properties&quot;)) {</span>
<span class="nc bnc" id="L39" title="All 2 branches missed.">            if (config != null) {</span>
<span class="nc" id="L40">                Config.load(config);</span>
            }
<span class="nc bnc" id="L42" title="All 8 branches missed.">        }</span>
<span class="nc" id="L43">    }</span>

    private boolean hasConfig() throws IOException {
<span class="nc" id="L46">        try (ByteArrayOutputStream outBuffer = new ByteArrayOutputStream()) {</span>
<span class="nc" id="L47">            Config.list(new PrintStream(outBuffer, true));</span>
<span class="nc" id="L48">            String cfg = outBuffer.toString();</span>
<span class="nc" id="L49">            return cfg.contains(&quot;=&quot;);</span>
<span class="nc bnc" id="L50" title="All 8 branches missed.">        }</span>
    }

    @Override
    public String getScheme() {
<span class="nc" id="L55">        return &quot;smb&quot;;</span>
    }

    @Override
    public FileSystem newFileSystem(URI uri, Map&lt;String, ?&gt; env) throws IOException {
<span class="nc" id="L60">        throw new UnsupportedOperationException();</span>
    }

    @Override
    public FileSystem getFileSystem(URI uri) {
<span class="nc" id="L65">        throw new UnsupportedOperationException();</span>
    }

    @Override
    public Path getPath(URI uri) {
        try {
<span class="nc" id="L71">            return new SMBPath(this, uri);</span>
<span class="nc" id="L72">        } catch(IOException | URISyntaxException e) {</span>
<span class="nc" id="L73">            throw new IllegalArgumentException(e);</span>
        }
    }

    @Override
    public SeekableByteChannel newByteChannel(Path path, Set&lt;? extends OpenOption&gt; options, FileAttribute&lt;?&gt;... attrs)
            throws IOException
    {
<span class="nc" id="L81">        SMBPath smbPath = toSMBPath(path);</span>
<span class="nc" id="L82">        return new SMBByteChannel(smbPath);</span>
    }

    @Override
    public DirectoryStream&lt;Path&gt; newDirectoryStream(Path dir, Filter&lt;? super Path&gt; filter) throws IOException {
<span class="nc" id="L87">        SMBBasePath smbFile = toSMBPath(dir);</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">        if (!smbFile.isAbsolute()) {</span>
<span class="nc" id="L89">            throw new IllegalArgumentException(dir.toString());</span>
        }

<span class="nc" id="L92">        return new SMBDirectoryStream(this, (SMBPath)smbFile, filter);</span>
    }

    @Override
    public void createDirectory(Path dir, FileAttribute&lt;?&gt;... attrs) throws IOException {
        try {
<span class="nc" id="L98">            toSMBPath(dir).getSmbFile().mkdirs();</span>
<span class="nc" id="L99">        } catch(SmbException e) {</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">            if (e.getNtStatus() == NtStatus.NT_STATUS_OBJECT_NAME_COLLISION) {</span>
<span class="nc" id="L101">                throw new FileAlreadyExistsException(dir.toString(), null, e.getMessage());</span>
            }
<span class="nc" id="L103">            throw new IOException(e);</span>
<span class="nc" id="L104">        }</span>
<span class="nc" id="L105">    }</span>

    @Override
    public void delete(Path path) throws IOException {
<span class="nc" id="L109">        SMBPath smbPath = toSMBPath(path);</span>
<span class="nc" id="L110">        smbPath.getSmbFile().delete();</span>
<span class="nc" id="L111">    }</span>

    @Override
    public void copy(Path source, Path target, CopyOption... options) throws IOException {
<span class="nc" id="L115">        throw new UnsupportedOperationException();</span>
    }

    @Override
    public void move(Path source, Path target, CopyOption... options) throws IOException {
<span class="nc" id="L120">        throw new UnsupportedOperationException();</span>
    }

    @Override
    public boolean isSameFile(Path path, Path path2) throws IOException {
<span class="nc" id="L125">        throw new UnsupportedOperationException();</span>
    }

    @Override
    public boolean isHidden(Path path) throws IOException {
<span class="nc" id="L130">        throw new UnsupportedOperationException();</span>
    }

    @Override
    public FileStore getFileStore(Path path) throws IOException {
<span class="nc" id="L135">        throw new UnsupportedOperationException();</span>
    }

    @Override
    public void checkAccess(Path path, AccessMode... modes) throws IOException {

<span class="nc bnc" id="L141" title="All 2 branches missed.">        if (!toSMBPath(path).getSmbFile().exists()) {</span>
<span class="nc" id="L142">            throw new NoSuchFileException(path.toString());</span>
        }
<span class="nc" id="L144">    }</span>

    @Override
    public &lt;V extends FileAttributeView&gt; V getFileAttributeView(Path path, Class&lt;V&gt; type, LinkOption... options) {
<span class="nc" id="L148">        throw new UnsupportedOperationException();</span>
    }

    @SuppressWarnings(&quot;unchecked&quot;)
    @Override
    public &lt;A extends BasicFileAttributes&gt; A readAttributes(Path path, Class&lt;A&gt; type, LinkOption... options) throws IOException {
<span class="nc bnc" id="L154" title="All 4 branches missed.">        if (type == BasicFileAttributes.class || type == SMBFileAttributes.class) {</span>
<span class="nc" id="L155">            return (A)toSMBPath(path).getAttributes();</span>
        }
<span class="nc" id="L157">        return null;</span>
    }

    @Override
    public Map&lt;String, Object&gt; readAttributes(Path path, String attributes, LinkOption... options) throws IOException {
<span class="nc" id="L162">        throw new UnsupportedOperationException();</span>
    }

    @Override
    public void setAttribute(Path path, String attribute, Object value, LinkOption... options) throws IOException {
<span class="nc" id="L167">        throw new UnsupportedOperationException();</span>
    }

    @SuppressWarnings(&quot;unchecked&quot;)
    public static &lt;A extends SMBBasePath&gt; A toSMBPath(Path path) {
<span class="nc bnc" id="L172" title="All 2 branches missed.">        if (path == null) {</span>
<span class="nc" id="L173">            throw new NullPointerException();</span>
        }
<span class="nc bnc" id="L175" title="All 2 branches missed.">        if (!(path instanceof SMBBasePath)) {</span>
<span class="nc" id="L176">            throw new ProviderMismatchException();</span>
        }
<span class="nc" id="L178">        return (A)path;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>